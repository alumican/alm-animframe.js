{"version":3,"file":"index.min.js","sources":["../src/AnimFrameEvent.ts","../src/AnimFrame.ts"],"sourcesContent":["export enum AnimFrameEventType {\n\ttick = 'tick',\n}\n\nexport class AnimFrameEvent extends CustomEvent<void> {\n\tconstructor(type:AnimFrameEventType) {\n\t\tsuper(type);\n\t}\n}\n","import {DateUtil} from \"alm\";\nimport {AnimFrameEvent, AnimFrameEventType} from \"./AnimFrameEvent\";\n\nexport class AnimFrame extends EventTarget {\n\n\t// --------------------------------------------------\n\t//\n\t// CONSTRUCTOR\n\t//\n\t// --------------------------------------------------\n\n\t/**\n\t * requestAnimationFrameベースでのFPSタイマー\n\t * @param {number} frameRate 目標フレームレート（0の場合はフレームレートを制限しない）\n\t * @param {number} tolerance 許容誤差（frameRateに対する割合）\n\t */\n\tconstructor(frameRate:number = 0, tolerance:number = 0.1) {\n\t\tsuper();\n\n\t\tif (!AnimFrame.requestAnimationFrame) {\n\t\t\tAnimFrame.provideFunctions();\n\t\t}\n\n\t\tthis.targetFrameRate = frameRate;\n\t\tthis.interval = 1000 / this.targetFrameRate;\n\n\t\tthis.tolerance = tolerance;\n\t\tthis.toleranceDuration = this.interval * this.tolerance;\n\n\t\tthis.isRunning = false;\n\t}\n\n\n\n\n\n\t// --------------------------------------------------\n\t//\n\t// METHOD\n\t//\n\t// --------------------------------------------------\n\n\tpublic start():void {\n\t\tif (this.isRunning) return;\n\t\tthis.isRunning = true;\n\n\t\tthis.frameStartTime = DateUtil.now();\n\t\tthis.requestId = window.requestAnimationFrame(this.updateHandler);\n\t}\n\n\tpublic stop():void {\n\t\tif (!this.isRunning) return;\n\t\tthis.isRunning = false;\n\n\t\twindow.cancelAnimationFrame(this.requestId);\n\t}\n\n\tpublic getIsRunning():boolean {\n\t\treturn this.isRunning;\n\t}\n\n\tpublic getTargetFrameRate():number {\n\t\treturn this.targetFrameRate;\n\t}\n\n\tpublic getInterval():number {\n\t\treturn this.interval;\n\t}\n\n\tpublic getTolerance():number {\n\t\treturn this.tolerance;\n\t}\n\n\tpublic getToleranceDuration():number {\n\t\treturn this.toleranceDuration;\n\t}\n\n\tprivate updateHandler = ():void => {\n\t\tthis.requestId = window.requestAnimationFrame(this.updateHandler);\n\t\tif (this.targetFrameRate > 0) {\n\t\t\tconst currentTime:number = DateUtil.now();\n\t\t\tconst elapsedTime:number = currentTime - this.frameStartTime;\n\t\t\tif (elapsedTime >= this.interval - this.toleranceDuration) {\n\t\t\t\tthis.frameStartTime = currentTime;\n\t\t\t\tthis.dispatchEvent(new AnimFrameEvent(AnimFrameEventType.tick));\n\t\t\t}\n\t\t} else {\n\t\t\tthis.dispatchEvent(new AnimFrameEvent(AnimFrameEventType.tick));\n\t\t}\n\t};\n\n\n\n\n\n\tpublic static addEventListener(listener:EventListener):void {\n\t\tconst index = AnimFrame.listeners.indexOf(listener);\n\t\tif (index === -1) {\n\t\t\tAnimFrame.ticker.addEventListener(AnimFrameEventType.tick, listener);\n\t\t\tAnimFrame.listeners.push(listener);\n\t\t\t++AnimFrame.listenerCount;\n\t\t\tif (AnimFrame.listenerCount === 1) {\n\t\t\t\tAnimFrame.ticker.start();\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic static removeEventListener(listener:EventListener):void {\n\t\tconst index = AnimFrame.listeners.indexOf(listener);\n\t\tif (index !== -1) {\n\t\t\tAnimFrame.ticker.removeEventListener(AnimFrameEventType.tick, listener);\n\t\t\tAnimFrame.listeners.splice(index, 1);\n\t\t\t--AnimFrame.listenerCount;\n\t\t\tif (AnimFrame.listenerCount === 0) {\n\t\t\t\tAnimFrame.ticker.stop();\n\t\t\t}\n\t\t}\n\t}\n\n\n\n\n\n\tprivate static provideFunctions():void {\n\t\tconst raf = {\n\t\t\trequestAnimationFrame: null,\n\t\t\tcancelAnimationFrame: null,\n\t\t};\n\n\t\t// for browser\n\t\tif (window) {\n\t\t\t// get default\n\t\t\traf.requestAnimationFrame = window.requestAnimationFrame;\n\t\t\traf.cancelAnimationFrame =\n\t\t\t\twindow.cancelAnimationFrame || window['cancelRequestAnimationFrame'];\n\n\t\t\t// resolve vendor prefix\n\t\t\tif (!raf.requestAnimationFrame) {\n\t\t\t\tconst prefixes = ['ms', 'moz', 'webkit', 'o'];\n\t\t\t\tfor (let i = 0; i < prefixes.length; ++i) {\n\t\t\t\t\tconst prefix = prefixes[i];\n\t\t\t\t\traf.requestAnimationFrame = window[prefix + 'RequestAnimationFrame'];\n\t\t\t\t\traf.cancelAnimationFrame =\n\t\t\t\t\t\twindow[prefix + 'CancelAnimationFrame'] ||\n\t\t\t\t\t\twindow[prefix + 'CancelRequestAnimationFrame'];\n\t\t\t\t\tif (raf.requestAnimationFrame) break;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// for node.js\n\t\tif (!raf.requestAnimationFrame) {\n\t\t\tconst fps = 60;\n\t\t\tconst t = 1000 / fps;\n\t\t\tlet prevTime = 0;\n\t\t\traf.requestAnimationFrame = (callback:FrameRequestCallback): number => {\n\t\t\t\tconst time = DateUtil.now();\n\t\t\t\tconst interval = Math.max(1, t - (time - prevTime));\n\t\t\t\tconst nextTime = time + interval;\n\t\t\t\tconst id = window.setTimeout(() => {\n\t\t\t\t\tcallback(nextTime);\n\t\t\t\t}, interval);\n\t\t\t\tprevTime = nextTime;\n\t\t\t\treturn id;\n\t\t\t};\n\t\t\traf.cancelAnimationFrame = (id): void => {\n\t\t\t\tclearTimeout(id);\n\t\t\t};\n\t\t}\n\n\t\tAnimFrame.requestAnimationFrame = raf.requestAnimationFrame;\n\t\tAnimFrame.cancelAnimationFrame = raf.cancelAnimationFrame;\n\t}\n\n\n\n\n\n\t// --------------------------------------------------\n\t//\n\t// MEMBER\n\t//\n\t// --------------------------------------------------\n\n\tprivate isRunning:boolean;\n\tprivate requestId:number;\n\tprivate targetFrameRate:number;\n\tprivate interval:number;\n\tprivate tolerance:number;\n\tprivate toleranceDuration:number;\n\tprivate frameStartTime:number;\n\n\tprivate static requestAnimationFrame:(callback:FrameRequestCallback) => number = null;\n\tprivate static cancelAnimationFrame:(handle:number) => void = null;\n\n\tprivate static ticker = new AnimFrame();\n\tprivate static listenerCount = 0;\n\tprivate static listeners:EventListener[] = [];\n}\n"],"names":["exports","AnimFrameEventType","AnimFrameEvent","CustomEvent","constructor","type","super","AnimFrame","EventTarget","frameRate","tolerance","this","updateHandler","requestId","window","requestAnimationFrame","targetFrameRate","currentTime","DateUtil","now","frameStartTime","interval","toleranceDuration","dispatchEvent","tick","provideFunctions","isRunning","start","stop","cancelAnimationFrame","getIsRunning","getTargetFrameRate","getInterval","getTolerance","getToleranceDuration","static","listener","listeners","indexOf","ticker","addEventListener","push","listenerCount","index","removeEventListener","splice","raf","prefixes","i","length","prefix","t","prevTime","callback","time","Math","max","nextTime","id","setTimeout","clearTimeout"],"mappings":"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"}