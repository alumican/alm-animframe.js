{"version":3,"file":"index.js","sources":["../src/AnimFrameEvent.ts","../src/AnimFrame.ts"],"sourcesContent":["export enum AnimFrameEventType {\n\ttick = 'tick',\n}\n\nexport class AnimFrameEvent extends CustomEvent<void> {\n\tconstructor(type:AnimFrameEventType) {\n\t\tsuper(type);\n\t}\n}\n","import {DateUtil} from \"alm\";\nimport {AnimFrameEvent, AnimFrameEventType} from \"./AnimFrameEvent\";\n\nexport class AnimFrame extends EventTarget {\n\n\t// --------------------------------------------------\n\t//\n\t// CONSTRUCTOR\n\t//\n\t// --------------------------------------------------\n\n\t/**\n\t * requestAnimationFrameベースでのFPSタイマー\n\t * @param {number} frameRate 目標フレームレート（0の場合はフレームレートを制限しない）\n\t * @param {number} tolerance 許容誤差（frameRateに対する割合）\n\t */\n\tconstructor(frameRate:number = 0, tolerance:number = 0.1) {\n\t\tsuper();\n\n\t\tif (!AnimFrame.requestAnimationFrame) {\n\t\t\tAnimFrame.provideFunctions();\n\t\t}\n\n\t\tthis.targetFrameRate = frameRate;\n\t\tthis.interval = 1000 / this.targetFrameRate;\n\n\t\tthis.tolerance = tolerance;\n\t\tthis.toleranceDuration = this.interval * this.tolerance;\n\n\t\tthis.isRunning = false;\n\t}\n\n\n\n\n\n\t// --------------------------------------------------\n\t//\n\t// METHOD\n\t//\n\t// --------------------------------------------------\n\n\tpublic start():void {\n\t\tif (this.isRunning) return;\n\t\tthis.isRunning = true;\n\n\t\tthis.frameStartTime = DateUtil.now();\n\t\tthis.requestId = window.requestAnimationFrame(this.updateHandler);\n\t}\n\n\tpublic stop():void {\n\t\tif (!this.isRunning) return;\n\t\tthis.isRunning = false;\n\n\t\twindow.cancelAnimationFrame(this.requestId);\n\t}\n\n\tpublic getIsRunning():boolean {\n\t\treturn this.isRunning;\n\t}\n\n\tpublic getTargetFrameRate():number {\n\t\treturn this.targetFrameRate;\n\t}\n\n\tpublic getInterval():number {\n\t\treturn this.interval;\n\t}\n\n\tpublic getTolerance():number {\n\t\treturn this.tolerance;\n\t}\n\n\tpublic getToleranceDuration():number {\n\t\treturn this.toleranceDuration;\n\t}\n\n\tprivate updateHandler = ():void => {\n\t\tthis.requestId = window.requestAnimationFrame(this.updateHandler);\n\t\tif (this.targetFrameRate > 0) {\n\t\t\tconst currentTime:number = DateUtil.now();\n\t\t\tconst elapsedTime:number = currentTime - this.frameStartTime;\n\t\t\tif (elapsedTime >= this.interval - this.toleranceDuration) {\n\t\t\t\tthis.frameStartTime = currentTime;\n\t\t\t\tthis.dispatchEvent(new AnimFrameEvent(AnimFrameEventType.tick));\n\t\t\t}\n\t\t} else {\n\t\t\tthis.dispatchEvent(new AnimFrameEvent(AnimFrameEventType.tick));\n\t\t}\n\t};\n\n\n\n\n\n\tpublic static addEventListener(listener:EventListener):void {\n\t\tconst index = AnimFrame.listeners.indexOf(listener);\n\t\tif (index === -1) {\n\t\t\tAnimFrame.ticker.addEventListener(AnimFrameEventType.tick, listener);\n\t\t\tAnimFrame.listeners.push(listener);\n\t\t\t++AnimFrame.listenerCount;\n\t\t\tif (AnimFrame.listenerCount === 1) {\n\t\t\t\tAnimFrame.ticker.start();\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic static removeEventListener(listener:EventListener):void {\n\t\tconst index = AnimFrame.listeners.indexOf(listener);\n\t\tif (index !== -1) {\n\t\t\tAnimFrame.ticker.removeEventListener(AnimFrameEventType.tick, listener);\n\t\t\tAnimFrame.listeners.splice(index, 1);\n\t\t\t--AnimFrame.listenerCount;\n\t\t\tif (AnimFrame.listenerCount === 0) {\n\t\t\t\tAnimFrame.ticker.stop();\n\t\t\t}\n\t\t}\n\t}\n\n\n\n\n\n\tprivate static provideFunctions():void {\n\t\tconst raf = {\n\t\t\trequestAnimationFrame: null,\n\t\t\tcancelAnimationFrame: null,\n\t\t};\n\n\t\t// for browser\n\t\tif (window) {\n\t\t\t// get default\n\t\t\traf.requestAnimationFrame = window.requestAnimationFrame;\n\t\t\traf.cancelAnimationFrame =\n\t\t\t\twindow.cancelAnimationFrame || window['cancelRequestAnimationFrame'];\n\n\t\t\t// resolve vendor prefix\n\t\t\tif (!raf.requestAnimationFrame) {\n\t\t\t\tconst prefixes = ['ms', 'moz', 'webkit', 'o'];\n\t\t\t\tfor (let i = 0; i < prefixes.length; ++i) {\n\t\t\t\t\tconst prefix = prefixes[i];\n\t\t\t\t\traf.requestAnimationFrame = window[prefix + 'RequestAnimationFrame'];\n\t\t\t\t\traf.cancelAnimationFrame =\n\t\t\t\t\t\twindow[prefix + 'CancelAnimationFrame'] ||\n\t\t\t\t\t\twindow[prefix + 'CancelRequestAnimationFrame'];\n\t\t\t\t\tif (raf.requestAnimationFrame) break;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// for node.js\n\t\tif (!raf.requestAnimationFrame) {\n\t\t\tconst fps = 60;\n\t\t\tconst t = 1000 / fps;\n\t\t\tlet prevTime = 0;\n\t\t\traf.requestAnimationFrame = (callback:FrameRequestCallback): number => {\n\t\t\t\tconst time = DateUtil.now();\n\t\t\t\tconst interval = Math.max(1, t - (time - prevTime));\n\t\t\t\tconst nextTime = time + interval;\n\t\t\t\tconst id = window.setTimeout(() => {\n\t\t\t\t\tcallback(nextTime);\n\t\t\t\t}, interval);\n\t\t\t\tprevTime = nextTime;\n\t\t\t\treturn id;\n\t\t\t};\n\t\t\traf.cancelAnimationFrame = (id): void => {\n\t\t\t\tclearTimeout(id);\n\t\t\t};\n\t\t}\n\n\t\tAnimFrame.requestAnimationFrame = raf.requestAnimationFrame;\n\t\tAnimFrame.cancelAnimationFrame = raf.cancelAnimationFrame;\n\t}\n\n\n\n\n\n\t// --------------------------------------------------\n\t//\n\t// MEMBER\n\t//\n\t// --------------------------------------------------\n\n\tprivate isRunning:boolean;\n\tprivate requestId:number;\n\tprivate targetFrameRate:number;\n\tprivate interval:number;\n\tprivate tolerance:number;\n\tprivate toleranceDuration:number;\n\tprivate frameStartTime:number;\n\n\tprivate static requestAnimationFrame:(callback:FrameRequestCallback) => number = null;\n\tprivate static cancelAnimationFrame:(handle:number) => void = null;\n\n\tprivate static ticker = new AnimFrame();\n\tprivate static listenerCount = 0;\n\tprivate static listeners:EventListener[] = [];\n}\n"],"names":["AnimFrameEventType","DateUtil"],"mappings":"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"}